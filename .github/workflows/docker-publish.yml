name: Docker Publish
on:
  push:
    branches: [ "main" ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ "main" ]
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
      
      - name: Generate Release Notes with GitHub Copilot
        if: startsWith(github.ref, 'refs/tags/')
        id: copilot_notes
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || git rev-list --max-parents=0 HEAD)
          CURRENT_TAG="${{ github.ref_name }}"
          
          COMMITS=$(git log --pretty=format:"- %s (%h) by %an" $PREVIOUS_TAG..HEAD)
          FILES_CHANGED=$(git diff --name-only $PREVIOUS_TAG..HEAD | head -30)
          DIFF_STATS=$(git diff --stat $PREVIOUS_TAG..HEAD)
          
          # Build context using jq to handle escaping safely
          JSON_CONTEXT=$(jq -n \
            --arg repo "${{ github.repository }}" \
            --arg prev "$PREVIOUS_TAG" \
            --arg curr "$CURRENT_TAG" \
            --arg commits "$COMMITS" \
            --arg files "$FILES_CHANGED" \
            --arg stats "$DIFF_STATS" \
            '{repository: $repo, previous_tag: $prev, current_tag: $curr, commits: $commits, files: $files, diff_stats: $stats}')

          # Generate notes using GitHub Models API
          # Note: GITHUB_TOKEN might need specific permissions or a PAT with GitHub Models access
          RELEASE_NOTES=$(curl -s -X POST https://models.inference.ai.azure.com/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -d "{
              \"messages\": [
                {
                  \"role\": \"system\",
                  \"content\": \"You are an expert technical writer. Generate professional release notes in Markdown with sections: What's New, Bug Fixes, Improvements, Breaking Changes (if any), and Docker Usage. Be clear and focus on user impact.\"
                },
                {
                  \"role\": \"user\",
                  \"content\": $(echo "$JSON_CONTEXT" | jq -Rs .)
                }
              ],
              \"model\": \"gpt-4o\",
              \"temperature\": 0.7,
              \"max_tokens\": 2000
            }" | jq -r '.choices[0].message.content // empty')
          
          if [ -z "$RELEASE_NOTES" ]; then
            RELEASE_NOTES="## Changes in this Release\n\n$COMMITS"
          fi
          
          echo "RELEASE_NOTES<<EOFMARKER" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT
      
      - name: Create Release Body
        if: startsWith(github.ref, 'refs/tags/')
        id: release_body
        run: |
          cat > /tmp/release_body.md << 'ENDOFBODY'
          ${{ steps.copilot_notes.outputs.RELEASE_NOTES }}
          
          ---
          
          ## ðŸ“¦ Installation
          
          ### Docker
          ENDOFBODY
          
          echo '```bash' >> /tmp/release_body.md
          echo 'docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}' >> /tmp/release_body.md
          echo '```' >> /tmp/release_body.md
          
          cat >> /tmp/release_body.md << 'ENDOFBODY'
          
          ### Docker Compose
          ENDOFBODY
          
          echo '```yaml' >> /tmp/release_body.md
          echo 'services:' >> /tmp/release_body.md
          echo '  app:' >> /tmp/release_body.md
          echo '    image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}' >> /tmp/release_body.md
          echo '```' >> /tmp/release_body.md
          
          cat >> /tmp/release_body.md << 'ENDOFBODY'
          
          ## ðŸ”— Links
          - [Container Registry](${{ github.server_url }}/${{ github.repository }}/pkgs/container/${{ github.event.repository.name }})
          - [Full Changelog](${{ github.server_url }}/${{ github.repository }}/compare/${{ github.ref_name }}...main)
          ENDOFBODY
          
          echo "BODY<<ENDOFFILE" >> $GITHUB_OUTPUT
          cat /tmp/release_body.md >> $GITHUB_OUTPUT
          echo "ENDOFFILE" >> $GITHUB_OUTPUT
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.release_body.outputs.BODY }}
          generate_release_notes: false